[pytest]
# Pytest configuration for PoE2 Build Optimizer

# Test discovery patterns
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Custom markers
markers =
    slow: marks tests as slow (external dependencies, integration tests, can be skipped with -m "not slow")
    parity: marks tests as parity tests (synthetic baseline consistency testing, Story 1.6 initial implementation)
    gui_parity: marks tests as TRUE GUI parity tests (validation against official PoB GUI baselines, Story 1.6 Option A)
    performance: marks performance benchmark tests (Story 1.8 batch calculation optimization)

# Output options
addopts =
    --strict-markers
    --tb=short
    --disable-warnings

# KNOWN ISSUE: Windows LuaJIT cleanup crashes (code 0xe24c4a02)
# - Integration tests PASS correctly, then crash during cleanup
# - This is a known LuaJIT Windows limitation, not a code bug
# - Mitigation: Use pytest-xdist for process isolation
#   pytest tests/integration/ -n auto --dist=loadfile
# - See: docs/decisions/ADR-003-windows-luajit-cleanup-mitigation.md

# Test paths
testpaths = tests

# Python path configuration
pythonpath = src

# Coverage configuration
# IMPORTANT: Use dot notation for module paths, not forward slashes
# Example (CORRECT):   pytest tests/unit/optimizer/test_convergence.py --cov=src.optimizer.convergence --cov-report=term-missing
# Example (INCORRECT): pytest tests/unit/optimizer/test_convergence.py --cov=src/optimizer/convergence --cov-report=term-missing
#
# Run all tests with coverage: pytest --cov=src --cov-report=html
# Run specific module: pytest path/to/test.py --cov=module.path --cov-report=term-missing
[coverage:run]
source = src
omit =
    */tests/*
    */test_*.py
    */__pycache__/*
    */site-packages/*

[coverage:report]
# Minimum coverage threshold (fail if below this percentage)
# Set to 0 initially, adjust upward as test coverage improves
fail_under = 0

# Show lines that are missing coverage
show_missing = true

# Exclude patterns from coverage reporting
exclude_lines =
    # Standard pragma to exclude specific lines
    pragma: no cover

    # Don't complain about defensive programming
    raise AssertionError
    raise NotImplementedError

    # Don't complain if tests don't hit debug code
    def __repr__
    if self\.debug

    # Don't complain if non-runnable code isn't run
    if __name__ == .__main__.:
    if TYPE_CHECKING:

    # Don't complain about abstract methods
    @(abc\.)?abstractmethod

[coverage:html]
directory = htmlcov
